<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>18å¤©ç”Ÿå•¤ OPS æˆ°æƒ…å®¤ v4.0 (Integrity)</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: '#050816',
            panel: '#0b1020',
            surface: '#111827',
            accent: '#38bdf8',
            danger: '#f87171',
            warning: '#facc15',
            success: '#34d399',
            muted: '#94a3b8'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          boxShadow: {
            'glow': '0 0 20px rgba(56, 189, 248, 0.15)',
            'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
          }
        }
      }
    }
  </script>

  <style>
    /* CSS Reset & Base */
    body { background-color: #050816; color: #f3f4f6; overflow: hidden; }
    
    /* ç»ç’ƒæ“¬æ…‹ */
    .glass {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* æ²è»¸ç¾åŒ– */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0b1020; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Loader å‹•ç•« */
    #loader { position: fixed; inset: 0; z-index: 9999; background: #050816; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .spinner { width: 50px; height: 50px; border: 3px solid rgba(56,189,248,0.3); border-radius: 50%; border-top-color: #38bdf8; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* åœ°åœ–ç›¸é—œ */
    .leaflet-container { background: #050816; font-family: inherit; }
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background-color: rgba(56, 189, 248, 0.6) !important;
    }
    .marker-cluster div {
      background-color: rgba(11, 16, 32, 0.9) !important;
      color: #fff !important;
      font-weight: bold;
    }
    
    /* æ‰‹æ©Ÿç‰ˆ Bottom Sheet */
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50; border-radius: 20px 20px 0 0;
      max-height: 85vh; display: flex; flex-direction: column;
    }
    .bottom-sheet.active { transform: translateY(0); }

    /* æˆ°æƒ…æ¨¡å¼æƒæç·š */
    .scanline {
      position: absolute; inset: 0; pointer-events: none; z-index: 10;
      background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.2) 50%);
      background-size: 100% 4px;
      animation: scan 10s linear infinite;
      opacity: 0.3;
    }
    @keyframes scan { from { background-position: 0 0; } to { background-position: 0 100%; } }
  </style>
</head>
<body class="h-screen flex flex-col antialiased selection:bg-accent selection:text-white">

  <div id="loader">
    <div class="spinner"></div>
    <div class="mt-4 text-sm text-accent font-mono tracking-widest animate-pulse">CONNECTING DATA SOURCE...</div>
    <div id="loader-status" class="mt-2 text-xs text-muted">Initialize Engine</div>
  </div>

  <header class="h-16 flex-none glass z-40 relative">
    <div class="h-full flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-blue-500 flex items-center justify-center shadow-lg shadow-blue-500/20">
          <i class="fa-solid fa-beer-mug-empty text-white text-xs"></i>
        </div>
        <div>
          <h1 class="text-sm font-bold text-white tracking-wide">OPS CONSOLE <span class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-accent">v4.0</span></h1>
          <div class="text-[10px] text-muted flex items-center gap-2">
             <span id="data-source-indicator" class="text-emerald-400">â— Live Data</span>
             <span id="last-update-time">--:--</span>
          </div>
        </div>
      </div>

      <div class="hidden md:flex gap-4">
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surface border border-white/5">
          <span class="w-2 h-2 rounded-full bg-danger animate-pulse"></span>
          <span class="text-xs text-muted">ç´…ç‡ˆ</span>
          <span class="text-sm font-bold text-white" id="header-crit">0</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surface border border-white/5">
          <span class="w-2 h-2 rounded-full bg-warning"></span>
          <span class="text-xs text-muted">é»ƒç‡ˆ</span>
          <span class="text-sm font-bold text-white" id="header-warn">0</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surface border border-white/5">
          <span class="w-2 h-2 rounded-full bg-success"></span>
          <span class="text-xs text-muted">å®Œæˆç‡</span>
          <span class="text-sm font-bold text-white" id="header-rate">0%</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button onclick="app.toggleWarMode()" class="px-3 py-1.5 rounded-lg bg-blue-600/20 text-blue-400 border border-blue-500/30 hover:bg-blue-600 hover:text-white transition-all text-xs font-medium flex items-center gap-2">
          <i class="fa-solid fa-map-location-dot"></i> <span class="hidden sm:inline">æˆ°æƒ…æ¨¡å¼</span>
        </button>
        <button onclick="app.toggleTheme()" class="w-8 h-8 rounded-lg bg-surface border border-white/10 text-muted hover:text-white transition flex items-center justify-center">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 flex overflow-hidden relative">
    
    <aside id="panel-list" class="w-full md:w-[380px] bg-panel flex flex-col border-r border-white/5 z-30 transition-transform duration-300 absolute md:relative h-full translate-x-0">
      
      <div class="p-3 border-b border-white/5 space-y-3 bg-panel/95 backdrop-blur z-10">
        <div class="relative group">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-muted group-focus-within:text-accent transition-colors text-xs"></i>
          <input type="text" id="search-input" placeholder="æœå°‹é–€å¸‚ã€åº—è™Ÿã€æ¥­å‹™..." 
                 class="w-full bg-surface border border-white/10 rounded-lg pl-9 pr-3 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/50 transition-all">
        </div>
        
        <div class="flex items-center justify-between gap-2">
          <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="filter-chips">
            </div>
          <div class="relative shrink-0">
            <select id="sort-select" class="appearance-none bg-surface border border-white/10 text-xs text-white rounded-md pl-2 pr-6 py-1.5 focus:outline-none cursor-pointer hover:border-white/30">
              <option value="priority">ğŸ”¥ å„ªå…ˆåº¦</option>
              <option value="sales">ğŸ’° éŠ·é‡é«˜</option>
              <option value="distance">ğŸ“ è·é›¢è¿‘</option>
            </select>
            <i class="fa-solid fa-caret-down absolute right-2 top-2 text-[10px] text-muted pointer-events-none"></i>
          </div>
        </div>
      </div>

      <div id="store-list" class="flex-1 overflow-y-auto p-2 space-y-2 pb-24 md:pb-2">
        </div>
      
      <div class="md:hidden absolute bottom-0 left-0 right-0 p-3 glass flex justify-around border-t border-white/5">
        <button class="flex flex-col items-center gap-1 text-accent" onclick="app.showList()">
          <i class="fa-solid fa-list text-lg"></i><span class="text-[10px]">åˆ—è¡¨</span>
        </button>
        <button class="flex flex-col items-center gap-1 text-muted hover:text-white" onclick="app.showMapMobile()">
          <i class="fa-solid fa-map text-lg"></i><span class="text-[10px]">åœ°åœ–</span>
        </button>
        <button class="flex flex-col items-center gap-1 text-muted hover:text-white" onclick="app.openFullTable()">
          <i class="fa-solid fa-table text-lg"></i><span class="text-[10px]">ç¸½è¡¨</span>
        </button>
      </div>
    </aside>

    <section id="panel-map" class="flex-1 relative bg-dark z-0 md:block hidden">
      <div id="map" class="w-full h-full outline-none"></div>
      
      <div class="absolute top-4 right-4 z-[400] flex flex-col gap-2">
        <button onclick="app.locateUser()" class="w-10 h-10 rounded-lg bg-surface/90 border border-white/10 text-white shadow-lg hover:bg-accent hover:border-accent transition flex items-center justify-center">
          <i class="fa-solid fa-crosshairs"></i>
        </button>
        <button onclick="app.toggleHeatmap()" class="w-10 h-10 rounded-lg bg-surface/90 border border-white/10 text-white shadow-lg hover:bg-orange-500 hover:border-orange-500 transition flex items-center justify-center" title="ç†±åŠ›åœ–">
          <i class="fa-solid fa-fire"></i>
        </button>
      </div>

      <div class="absolute bottom-6 left-6 z-[400] flex gap-2">
        <button onclick="app.setMapFilter('all')" class="px-3 py-1.5 rounded-full bg-surface/90 border border-white/10 text-xs text-white shadow-lg hover:bg-white/10">å…¨éƒ¨</button>
        <button onclick="app.setMapFilter('critical')" class="px-3 py-1.5 rounded-full bg-surface/90 border border-red-500/30 text-xs text-red-400 shadow-lg hover:bg-red-500/10">åƒ…ç•°å¸¸</button>
      </div>
    </section>

    <aside id="detail-panel" class="md:w-[400px] md:border-l md:border-white/5 bg-panel flex flex-col z-40 transition-transform duration-300 md:translate-x-full absolute right-0 top-0 bottom-0 h-full bottom-sheet md:static md:block">
      <div class="md:hidden h-1 w-12 bg-white/20 rounded-full mx-auto my-3 shrink-0"></div>

      <div class="p-5 border-b border-white/5 shrink-0 flex justify-between items-start bg-panel">
        <div>
           <div class="flex items-center gap-2 mb-1">
             <span id="d-status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500 shadow-glow"></span>
             <h2 id="d-name" class="text-xl font-bold text-white tracking-wide">--</h2>
           </div>
           <p class="text-xs text-muted font-mono"><span id="d-id">#--</span> Â· <span id="d-region">--</span></p>
        </div>
        <button onclick="app.closeDetail()" class="text-muted hover:text-white transition p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-5 space-y-6">
        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 rounded-xl bg-surface border border-white/5 text-center">
            <div class="text-[10px] text-muted uppercase tracking-wider mb-1">Weekly Sales</div>
            <div id="d-sales" class="text-xl font-bold text-white">0</div>
          </div>
          <div class="p-3 rounded-xl bg-surface border border-white/5 text-center relative overflow-hidden">
            <div class="text-[10px] text-muted uppercase tracking-wider mb-1">Inventory</div>
            <div id="d-inv" class="text-xl font-bold text-accent">0</div>
            <div class="absolute bottom-0 left-0 h-1 bg-accent/20 w-full"><div id="d-inv-bar" class="h-full bg-accent" style="width:0%"></div></div>
          </div>
          <div class="p-3 rounded-xl bg-surface border border-white/5 text-center">
            <div class="text-[10px] text-muted uppercase tracking-wider mb-1">PSD</div>
            <div id="d-psd" class="text-xl font-bold text-white">0.0</div>
          </div>
        </div>

        <div class="p-4 rounded-xl bg-surface border border-white/5">
           <div class="flex justify-between items-center mb-4">
             <h3 class="text-xs font-bold text-white">ä¸ƒæ—¥éŠ·å”®è¶¨å‹¢</h3>
             <span id="d-growth" class="text-xs font-mono">--%</span>
           </div>
           <div class="h-40 relative">
             <canvas id="chart-flow"></canvas>
           </div>
        </div>

        <div class="p-4 rounded-xl bg-surface border border-white/5 flex gap-4 items-center">
           <div class="w-24 h-24 shrink-0 relative">
             <canvas id="chart-pattern"></canvas>
           </div>
           <div class="flex-1 space-y-2">
             <div class="flex justify-between text-xs"><span class="text-muted">å¹³æ—¥</span><span class="text-white" id="d-weekday">0</span></div>
             <div class="flex justify-between text-xs"><span class="text-muted">å‡æ—¥</span><span class="text-white" id="d-weekend">0</span></div>
             <div class="h-px bg-white/10 my-2"></div>
             <div class="text-xs text-accent" id="d-pattern-type">--å‹æ…‹</div>
           </div>
        </div>

        <div class="space-y-3 text-sm text-muted">
           <div class="flex justify-between py-2 border-b border-white/5">
             <span>è² è²¬æ¥­å‹™</span>
             <span id="d-rep" class="text-white">--</span>
           </div>
           <div class="flex justify-between py-2 border-b border-white/5">
             <span>æœ€å¾Œé€²è²¨</span>
             <span id="d-last-delivery" class="text-white font-mono">--</span>
           </div>
           <div class="flex justify-between py-2 border-b border-white/5">
             <span>ç•°å¸¸åŸå› </span>
             <span id="d-reason" class="text-danger font-medium">--</span>
           </div>
           <div class="flex justify-between py-2 border-b border-white/5">
             <span>åœ°å€</span>
             <span id="d-addr" class="text-white text-right max-w-[200px] truncate">--</span>
           </div>
        </div>
      </div>

      <div class="p-4 border-t border-white/5 bg-panel/95 backdrop-blur flex gap-3 shrink-0">
        <button onclick="app.handleNav()" class="flex-1 py-3 rounded-xl bg-surface border border-white/10 hover:bg-white/10 transition text-sm font-bold text-white flex items-center justify-center gap-2">
          <i class="fa-solid fa-location-arrow"></i> å°èˆª
        </button>
        <button onclick="app.handleNotify()" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-500/20 transition text-sm font-bold text-white flex items-center justify-center gap-2">
          <i class="fa-brands fa-line"></i> é€šçŸ¥
        </button>
        <button id="btn-mark-done" onclick="app.toggleDone()" class="flex-1 py-3 rounded-xl bg-surface border border-white/10 hover:border-success/50 hover:text-success transition text-sm font-bold text-muted flex items-center justify-center gap-2">
          <i class="fa-solid fa-check"></i> è™•ç†
        </button>
      </div>
    </aside>
  </main>

  <div id="war-room" class="fixed inset-0 bg-black z-[100] hidden flex-col">
    <div class="absolute top-0 left-0 right-0 p-6 flex justify-between items-start z-20 pointer-events-none">
      <div class="bg-black/80 border border-accent/50 text-accent px-4 py-2 font-mono text-xl tracking-widest shadow-glow backdrop-blur pointer-events-auto">
        WAR ROOM <span class="animate-pulse">â—</span>
      </div>
      <button onclick="app.toggleWarMode()" class="pointer-events-auto bg-red-500/20 border border-red-500 text-red-500 px-6 py-2 hover:bg-red-500 hover:text-white transition uppercase font-bold tracking-wider">
        EXIT
      </button>
    </div>
    <div class="scanline"></div>
    <div id="war-map-container" class="flex-1 relative bg-black"></div>
    
    <div class="absolute bottom-10 left-10 right-10 flex gap-6 z-20 pointer-events-none">
       <div class="bg-black/80 border border-white/10 p-4 flex-1 backdrop-blur rounded-lg pointer-events-auto">
          <div class="text-xs text-muted mb-1">TOTAL CRITICAL</div>
          <div class="text-3xl font-bold text-danger" id="war-stat-crit">0</div>
       </div>
       <div class="bg-black/80 border border-white/10 p-4 flex-1 backdrop-blur rounded-lg pointer-events-auto">
          <div class="text-xs text-muted mb-1">TOTAL SALES</div>
          <div class="text-3xl font-bold text-accent" id="war-stat-sales">0</div>
       </div>
    </div>
  </div>

  <div id="modal-table" class="fixed inset-0 bg-dark/90 backdrop-blur z-[200] hidden flex-col p-4 md:p-10">
    <div class="bg-panel w-full h-full rounded-2xl border border-white/10 flex flex-col shadow-2xl overflow-hidden">
      <div class="p-5 border-b border-white/10 flex justify-between items-center bg-surface">
        <h2 class="text-xl font-bold text-white"><i class="fa-solid fa-table mr-2 text-accent"></i> å…¨éƒ¨é–€å¸‚ç¸½è¦½</h2>
        <button onclick="app.closeTable()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center text-white transition">âœ•</button>
      </div>
      <div class="flex-1 overflow-auto p-0">
        <table class="w-full text-left border-collapse">
          <thead class="bg-surface sticky top-0 z-10 text-xs text-muted uppercase">
            <tr>
              <th class="p-4 border-b border-white/10">ID</th>
              <th class="p-4 border-b border-white/10">é–€å¸‚åç¨±</th>
              <th class="p-4 border-b border-white/10">å€åŸŸ</th>
              <th class="p-4 border-b border-white/10 text-right">éŠ·é‡</th>
              <th class="p-4 border-b border-white/10 text-right">åº«å­˜</th>
              <th class="p-4 border-b border-white/10">ç‹€æ…‹</th>
              <th class="p-4 border-b border-white/10">è™•ç†</th>
            </tr>
          </thead>
          <tbody id="table-body" class="text-sm text-gray-300 font-mono">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-surface border border-white/10 px-6 py-3 rounded-full shadow-2xl z-[3000] flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none">
    <i class="fa-solid fa-circle-check text-success"></i>
    <span id="toast-msg" class="text-sm font-bold text-white">æ“ä½œæˆåŠŸ</span>
  </div>

  <script>
    /**
     * V4.0 æ ¸å¿ƒé‚è¼¯æ¨¡çµ„
     * åŒ…å« CSV è§£æã€æ¨¡æ“¬è³‡æ–™Fallbackã€åœ°åœ–èˆ‡åœ–è¡¨æ§åˆ¶
     */
    const App = (() => {
      // --- é…ç½®åƒæ•¸ ---
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVxK10bag9WaT5RPkA5BdsNF98cO8d1xH2oqHVemf5vJ6vGBp-Q0LDrel4k1eCS8ht72Tcuc4YwVzM/pub?gid=0&single=true&output=csv';
      const TIMEOUT_MS = 2500; // è¶…é 2.5 ç§’æœªè®€åˆ° CSV å°±åˆ‡æ›æ¨¡æ“¬è³‡æ–™

      // --- ç‹€æ…‹è®Šæ•¸ ---
      let stores = [];
      let map = null, warMap = null;
      let markers = {}, markerCluster = null;
      let activeStore = null;
      let charts = { flow: null, pattern: null };
      let filters = { status: 'all', search: '' };
      let sortBy = 'priority';

      // --- 1. è³‡æ–™å±¤ (Data Layer) ---
      
      // CSV è§£æå™¨ (é‚„åŸ v13 é‚è¼¯)
      const parseCSV = (text) => {
        const rows = text.split('\n').map(row => row.trim()).filter(row => row);
        if(rows.length < 2) return [];
        const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
        
        return rows.slice(1).map(row => {
          // è™•ç† CSV ä¸­çš„é€—è™Ÿèˆ‡å¼•è™Ÿ (ç°¡æ˜“ç‰ˆ Regex)
          const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || []; 
          const clean = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';
          
          // æ˜ å°„è³‡æ–™
          const raw = {};
          headers.forEach((h, i) => raw[h] = clean(cols[i]));
          
          // è½‰æ›ç‚º App æ ¼å¼
          const sales = parseInt(raw['weekly sales'] || 0);
          const inv = parseInt(raw['current inventory'] || 0);
          const psd = parseFloat(raw['psd value'] || 0);
          
          // åˆ¤æ–·é‚è¼¯ (v13 é‚è¼¯)
          let alert = 'normal', reason = '-';
          if(inv < psd * 1.5) { alert = 'critical'; reason = 'åº«å­˜æ¥µä½'; }
          else if(inv < psd * 3.5) { alert = 'warning'; reason = 'æ°´ä½åä½'; }
          
          return {
            id: raw['store id'] || 'Unknown',
            name: raw['store name'] || 'Unknown',
            region: raw['region'] || '',
            address: raw['address'] || '',
            rep: raw['sales rep name'] || 'æœªåˆ†é…',
            lat: parseFloat(raw['latitude'] || 0),
            lng: parseFloat(raw['longitude'] || 0),
            sales, inv, psd,
            growth: parseFloat(raw['weekly growth rate'] || 0),
            alert, reason,
            route: raw['route code'] || '',
            lastUpdate: raw['last update'] || new Date().toLocaleString(),
            weeklyFlow: (raw['weekly flow'] || '').split('|').map(Number),
            isDone: false // æœ¬åœ°ç‹€æ…‹
          };
        }).filter(s => s.lat && s.lng); // éæ¿¾ç„¡æ•ˆåº§æ¨™
      };

      // æ¨¡æ“¬è³‡æ–™ç”¢ç”Ÿå™¨ (Failsafe)
      const generateMockData = () => {
        const regions = ['å°åŒ—å¸‚','æ–°åŒ—å¸‚','æ¡ƒåœ’å¸‚','å°ä¸­å¸‚','å°å—å¸‚','é«˜é›„å¸‚','å®œè˜­ç¸£'];
        return Array.from({length: 40}, (_, i) => {
          const sales = Math.floor(Math.random()*200)+10;
          const inv = Math.floor(Math.random()*100);
          const psd = (sales/7).toFixed(1);
          let alert = 'normal', reason = '-';
          if(inv < psd*2) { alert='critical'; reason='åº«å­˜æ¥µä½'; }
          else if(inv < psd*4) { alert='warning'; reason='æ°´ä½åä½'; }
          
          return {
            id: `S${1000+i}`, name: `ç¶“éŠ·é–€å¸‚ ${i+1}`, region: regions[i%7],
            rep: ['é™³é“å¹³','æ—æƒ ç','å¼µå‹æ–‡'][i%3],
            address: `æ¨¡æ“¬åœ°å€è·¯æ®µ ${i+10} è™Ÿ`,
            lat: 23.6+(Math.random()-0.5)*2.5, lng: 121+(Math.random()-0.5)*1.5,
            sales, inv, psd,
            growth: (Math.random()-0.5)*0.8,
            alert, reason,
            route: ['A01','B02','C03'][i%3],
            lastUpdate: new Date().toLocaleTimeString(),
            weeklyFlow: Array.from({length:7}, ()=>Math.floor(Math.random()*50)),
            isDone: false
          };
        });
      };

      // å„ªå…ˆåº¦è¨ˆç®— (å•†æ¥­é‚è¼¯)
      const computePriority = (s) => {
        let score = s.sales;
        if(s.alert === 'critical') score += 500;
        if(s.alert === 'warning') score += 200;
        if(!s.isDone) score += 1000; // æœªè™•ç†å„ªå…ˆ
        return score;
      };

      // è³‡æ–™è¼‰å…¥æµç¨‹ (åŒ…å« Timeout ä¿è­·)
      const initData = async () => {
        const loader = document.getElementById('loader');
        const status = document.getElementById('loader-status');
        const indicator = document.getElementById('data-source-indicator');
        
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error("Timeout")), TIMEOUT_MS)
        );

        try {
          status.innerText = "Fetching Google Sheets...";
          const response = await Promise.race([fetch(CSV_URL), timeoutPromise]);
          
          if (!response.ok) throw new Error("Network Error");
          const text = await response.text();
          stores = parseCSV(text);
          if (stores.length === 0) throw new Error("Empty Data");
          
          indicator.innerText = "â— Live Data";
          indicator.className = "text-emerald-400";
        } catch (error) {
          console.warn("Falling back to mock data:", error);
          stores = generateMockData();
          indicator.innerText = "â— Mock Mode";
          indicator.className = "text-amber-400";
          showToast("é€£ç·šé€¾æ™‚ï¼Œå·²åˆ‡æ›è‡³æ¨¡æ“¬æ¨¡å¼", "warning");
        }

        // è®€å– LocalStorage ç‹€æ…‹ (æ˜¯å¦å·²å®Œæˆ)
        const savedState = JSON.parse(localStorage.getItem('ops_v4_state') || '{}');
        stores.forEach(s => {
          if(savedState[s.id]) s.isDone = true;
          s.priority = computePriority(s);
        });

        // ç§»é™¤ Loader
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 500);
        
        initUI();
      };

      // --- 2. ä»‹é¢é‚è¼¯ (UI Layer) ---
      
      const initUI = () => {
        initMap();
        renderFilters();
        renderList();
        updateStats();
        
        // æœå°‹ç›£è½
        document.getElementById('search-input').addEventListener('input', (e) => {
          filters.search = e.target.value.toLowerCase();
          renderList();
        });
        
        // æ’åºç›£è½
        document.getElementById('sort-select').addEventListener('change', (e) => {
          sortBy = e.target.value;
          renderList();
        });
      };

      const renderFilters = () => {
        const btns = [
          {id:'all', t:'å…¨éƒ¨', c:'bg-white/5 border-white/10'},
          {id:'critical', t:'ğŸ”´ ç•°å¸¸', c:'bg-red-500/10 text-red-400 border-red-500/30'},
          {id:'warning', t:'ğŸŸ¡ è­¦ç¤º', c:'bg-yellow-500/10 text-yellow-400 border-yellow-500/30'},
          {id:'undone', t:'ğŸ“ æœªè™•ç†', c:'bg-blue-500/10 text-blue-400 border-blue-500/30'}
        ];
        
        document.getElementById('filter-chips').innerHTML = btns.map(b => `
          <button onclick="app.setFilter('${b.id}')" 
            class="px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all ${filters.status===b.id ? 'bg-accent text-dark border-accent' : b.c} hover:border-accent">
            ${b.t}
          </button>
        `).join('');
      };

      const getFilteredStores = () => {
        let list = stores.filter(s => {
          if(filters.status === 'critical') return s.alert === 'critical';
          if(filters.status === 'warning') return s.alert === 'warning';
          if(filters.status === 'undone') return !s.isDone;
          return true;
        });
        
        if(filters.search) {
          list = list.filter(s => 
            s.name.includes(filters.search) || 
            s.id.includes(filters.search) || 
            s.rep.includes(filters.search)
          );
        }
        
        return list.sort((a,b) => {
          if(sortBy === 'sales') return b.sales - a.sales;
          if(sortBy === 'distance') return 0; // éœ€å¯¦ä½œå®šä½è¨ˆç®—
          return b.priority - a.priority; // Default
        });
      };

      const renderList = () => {
        const list = getFilteredStores();
        const container = document.getElementById('store-list');
        
        container.innerHTML = list.map(s => {
          const statusColor = s.alert==='critical'?'bg-danger shadow-red-500/50':(s.alert==='warning'?'bg-warning shadow-yellow-500/50':'bg-success shadow-green-500/50');
          const activeClass = activeStore?.id === s.id ? 'border-accent bg-blue-500/5 ring-1 ring-accent' : 'border-white/5 bg-surface hover:border-white/20';
          const doneClass = s.isDone ? 'opacity-60 grayscale' : '';
          
          return `
            <div onclick="app.selectStore('${s.id}')" class="p-3 rounded-xl border transition-all cursor-pointer relative group ${activeClass} ${doneClass}">
               <div class="flex justify-between items-start mb-2">
                 <div class="flex items-center gap-2">
                   <span class="w-2.5 h-2.5 rounded-full ${statusColor} shadow-lg"></span>
                   <span class="font-bold text-sm text-white group-hover:text-accent transition-colors">${s.name}</span>
                   ${s.isDone ? '<i class="fa-solid fa-circle-check text-success ml-1"></i>' : ''}
                 </div>
                 <span class="text-xs text-muted font-mono tracking-wide">${s.id}</span>
               </div>
               <div class="flex items-end justify-between">
                 <div class="text-xs text-muted space-y-1">
                   <div>${s.region} Â· ${s.rep}</div>
                   <div class="flex gap-2">
                      <span class="${s.inv < s.psd*2 ? 'text-danger' : 'text-gray-400'}">INV: ${s.inv}</span>
                      <span>PSD: ${s.psd}</span>
                   </div>
                 </div>
                 <div class="text-right">
                   <div class="text-[10px] text-gray-500 uppercase">Weekly Sales</div>
                   <div class="text-lg font-bold text-white leading-none">${s.sales}</div>
                 </div>
               </div>
            </div>
          `;
        }).join('');
        
        updateMapMarkers(list);
      };

      // --- 3. åœ°åœ–é‚è¼¯ (Leaflet) ---
      
      const initMap = () => {
        map = L.map('map', { zoomControl: false }).setView([23.8, 121], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19, attribution: 'Â© CARTO'
        }).addTo(map);
        
        markerCluster = L.markerClusterGroup({
          disableClusteringAtZoom: 14,
          showCoverageOnHover: false,
          iconCreateFunction: function(cluster) {
            return L.divIcon({ 
              html: `<div class="flex items-center justify-center w-10 h-10 bg-panel border-2 border-accent text-white font-bold rounded-full shadow-glow">${cluster.getChildCount()}</div>`, 
              className: 'custom-cluster', iconSize: L.point(40, 40) 
            });
          }
        });
        map.addLayer(markerCluster);
      };

      const updateMapMarkers = (list) => {
        if(!map) return;
        markerCluster.clearLayers();
        markers = {};
        
        list.forEach(s => {
          const color = s.alert==='critical'?'#f87171':(s.alert==='warning'?'#facc15':'#34d399');
          const m = L.circleMarker([s.lat, s.lng], {
            radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
          });
          m.bindPopup(`<b style="color:#000">${s.name}</b><br>éŠ·é‡: ${s.sales}`);
          m.on('click', () => selectStore(s.id));
          markerCluster.addLayer(m);
          markers[s.id] = m;
        });
      };

      // --- 4. äº’å‹•é‚è¼¯ (Interaction) ---

      const selectStore = (id) => {
        activeStore = stores.find(s => s.id === id);
        renderList();
        
        // åœ°åœ–é£›è¶Š
        if(map) map.setView([activeStore.lat, activeStore.lng], 14, { animate: true });
        
        // è©³ç´°é è³‡æ–™å¡«å……
        const fields = {
          'd-name': activeStore.name,
          'd-id': `#${activeStore.id}`,
          'd-region': activeStore.region,
          'd-sales': activeStore.sales,
          'd-inv': activeStore.inv,
          'd-psd': activeStore.psd,
          'd-rep': activeStore.rep,
          'd-addr': activeStore.address,
          'd-last-delivery': '2023-12-10', // æ¨¡æ“¬
          'd-reason': activeStore.reason,
          'd-growth': (activeStore.growth>0?'+':'') + (activeStore.growth*100).toFixed(1) + '%'
        };
        
        for(let k in fields) {
           const el = document.getElementById(k);
           if(el) el.innerText = fields[k];
        }

        // åº«å­˜æ¢
        const invBar = document.getElementById('d-inv-bar');
        const invPct = Math.min(100, (activeStore.inv / (activeStore.psd * 7)) * 100);
        invBar.style.width = `${invPct}%`;
        invBar.className = `h-full ${activeStore.alert==='critical'?'bg-danger':activeStore.alert==='warning'?'bg-warning':'bg-success'}`;

        // ç‹€æ…‹ç‡ˆ
        const dot = document.getElementById('d-status-dot');
        dot.className = `w-2.5 h-2.5 rounded-full shadow-glow ${activeStore.alert==='critical'?'bg-danger':activeStore.alert==='warning'?'bg-warning':'bg-success'}`;

        // æŒ‰éˆ•ç‹€æ…‹
        const btn = document.getElementById('btn-mark-done');
        if(activeStore.isDone) {
          btn.innerHTML = '<i class="fa-solid fa-rotate-left text-muted"></i> <span class="text-muted">å–æ¶ˆ</span>';
          btn.className = btn.className.replace('border-success/50', 'border-white/10');
        } else {
          btn.innerHTML = '<i class="fa-solid fa-check text-success"></i> <span class="text-white">è™•ç†</span>';
        }

        // ç¹ªè£½åœ–è¡¨
        drawCharts(activeStore);

        // æ‰‹æ©Ÿç‰ˆï¼šé–‹å•ŸæŠ½å±œ
        if(window.innerWidth < 768) {
          document.getElementById('panel-list').classList.add('-translate-x-full');
          document.getElementById('detail-panel').classList.add('active');
        } else {
          // Desktop: å³å´æ»‘å‡º
          document.getElementById('detail-panel').classList.remove('md:translate-x-full');
        }
      };

      const closeDetail = () => {
        if(window.innerWidth < 768) {
           document.getElementById('panel-list').classList.remove('-translate-x-full');
           document.getElementById('detail-panel').classList.remove('active');
        } else {
           document.getElementById('detail-panel').classList.add('md:translate-x-full');
        }
        activeStore = null;
        renderList();
        if(map) map.setView([23.8, 121], 7);
      };

      // Chart.js å¯¦ä½œ
      const drawCharts = (s) => {
        // Flow Chart
        const ctx1 = document.getElementById('chart-flow').getContext('2d');
        if(charts.flow) charts.flow.destroy();
        
        const gradient = ctx1.createLinearGradient(0,0,0,160);
        gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)');
        gradient.addColorStop(1, 'rgba(56, 189, 248, 0)');

        charts.flow = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: ['M','T','W','T','F','S','S'],
            datasets: [{
              data: s.weeklyFlow || [10,20,15,30,25,40,35],
              borderColor: '#38bdf8', borderWidth: 2,
              backgroundColor: gradient, fill: true,
              pointRadius: 0, pointHoverRadius: 4, tension: 0.4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: {display:false} },
            scales: { x: {display:false}, y: {display:false} }
          }
        });

        // Pattern Chart
        const ctx2 = document.getElementById('chart-pattern').getContext('2d');
        if(charts.pattern) charts.pattern.destroy();
        
        const weekday = Math.floor(s.sales * 0.6);
        const weekend = s.sales - weekday;
        document.getElementById('d-weekday').innerText = weekday;
        document.getElementById('d-weekend').innerText = weekend;
        document.getElementById('d-pattern-type').innerText = weekday > weekend ? 'å¹³æ—¥å‹' : 'å‡æ—¥å‹';

        charts.pattern = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['å¹³æ—¥','å‡æ—¥'],
            datasets: [{
              data: [weekday, weekend],
              backgroundColor: ['#38bdf8', '#f87171'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: {display:false} },
            cutout: '70%'
          }
        });
      };

      // --- 5. åŠŸèƒ½æ“ä½œ (Actions) ---
      
      const toggleDone = () => {
        if(!activeStore) return;
        activeStore.isDone = !activeStore.isDone;
        
        // æ›´æ–° LocalStorage
        const state = JSON.parse(localStorage.getItem('ops_v4_state') || '{}');
        if(activeStore.isDone) state[activeStore.id] = true;
        else delete state[activeStore.id];
        localStorage.setItem('ops_v4_state', JSON.stringify(state));
        
        activeStore.priority = computePriority(activeStore); // é‡æ–°è¨ˆç®—å„ªå…ˆåº¦
        selectStore(activeStore.id); // åˆ·æ–° UI
        showToast(activeStore.isDone ? 'å·²æ¨™è¨˜å®Œæˆ' : 'å·²å–æ¶ˆæ¨™è¨˜');
        updateStats();
      };

      const updateStats = () => {
        const crit = stores.filter(s=>s.alert==='critical').length;
        const warn = stores.filter(s=>s.alert==='warning').length;
        const done = stores.filter(s=>s.isDone).length;
        const rate = Math.round((done/stores.length)*100) || 0;
        
        document.getElementById('header-crit').innerText = crit;
        document.getElementById('header-warn').innerText = warn;
        document.getElementById('header-rate').innerText = rate + '%';
      };

      const showToast = (msg, type='info') => {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.style.opacity = '1'; t.style.transform = 'translateX(-50%) translateY(0)';
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(-20px)'; }, 2000);
      };

      // æˆ°æƒ…æ¨¡å¼åˆ‡æ›
      const toggleWarMode = () => {
        const war = document.getElementById('war-room');
        if(war.classList.contains('hidden')) {
          war.classList.remove('hidden');
          war.classList.add('flex');
          // åˆå§‹åŒ–æˆ°æƒ…åœ°åœ– (åªåšä¸€æ¬¡)
          if(!warMap) {
            setTimeout(() => {
              warMap = L.map('war-map-container', {zoomControl:false, attributionControl:false}).setView([23.8, 121], 8);
              L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(warMap);
              // åŠ å…¥ç°¡å–®ç´…é»
              stores.forEach(s => {
                 if(s.alert === 'critical' || s.alert === 'warning') {
                   L.circleMarker([s.lat, s.lng], {radius:4, color:'#f87171', fillOpacity:1}).addTo(warMap);
                 }
              });
            }, 100);
          }
          // æ›´æ–°æˆ°æƒ…æ•¸æ“š
          const salesTotal = stores.reduce((a,b)=>a+b.sales,0);
          document.getElementById('war-stat-sales').innerText = salesTotal.toLocaleString();
          document.getElementById('war-stat-crit').innerText = stores.filter(s=>s.alert==='critical').length;
        } else {
          war.classList.add('hidden');
          war.classList.remove('flex');
        }
      };
      
      // å…¨è¡¨æ¨¡å¼
      const openFullTable = () => {
        document.getElementById('modal-table').classList.remove('hidden');
        document.getElementById('modal-table').classList.add('flex');
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = stores.map(s => `
          <tr class="border-b border-white/5 hover:bg-white/5 cursor-pointer" onclick="app.selectStore('${s.id}');app.closeTable()">
             <td class="p-4 text-muted">${s.id}</td>
             <td class="p-4 text-white font-bold">${s.name}</td>
             <td class="p-4 text-muted">${s.region}</td>
             <td class="p-4 text-right text-white font-mono">${s.sales}</td>
             <td class="p-4 text-right ${s.alert==='critical'?'text-danger':'text-muted'}">${s.inv}</td>
             <td class="p-4"><span class="px-2 py-1 rounded text-xs ${s.alert==='critical'?'bg-danger/20 text-danger':'bg-white/5 text-muted'}">${s.alert}</span></td>
             <td class="p-4 text-center">${s.isDone?'âœ…':''}</td>
          </tr>
        `).join('');
      };

      const closeTable = () => {
        document.getElementById('modal-table').classList.add('hidden');
        document.getElementById('modal-table').classList.remove('flex');
      };

      // æ‰‹æ©Ÿåˆ‡æ›è¦–åœ–
      const showList = () => {
        document.getElementById('panel-list').classList.remove('-translate-x-full');
        document.getElementById('panel-map').classList.add('hidden');
      };
      const showMapMobile = () => {
        document.getElementById('panel-list').classList.add('-translate-x-full');
        document.getElementById('panel-map').classList.remove('hidden');
        document.getElementById('panel-map').classList.add('block');
        setTimeout(() => map.invalidateSize(), 300);
      };

      // æš´éœ² API
      return {
        initData, 
        setFilter: (f) => { filters.status = f; renderList(); renderFilters(); },
        selectStore, closeDetail, toggleDone, toggleWarMode, openFullTable, closeTable,
        showList, showMapMobile,
        handleNav: () => activeStore && window.open(`https://www.google.com/maps/dir/?api=1&destination=${activeStore.lat},${activeStore.lng}`),
        handleNotify: () => showToast(`å·²é€šçŸ¥: ${activeStore?.rep}`, 'success'),
        locateUser: () => navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 13)),
        toggleTheme: () => document.documentElement.classList.toggle('dark') // ç°¡æ˜“åˆ‡æ›
      };
    })();

    // å•Ÿå‹•
    document.addEventListener('DOMContentLoaded', App.initData);
    // ç¶å®šå…¨åŸŸ
    window.app = App;
  </script>
</body>
</html>